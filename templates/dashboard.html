<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>MBU Trading Bot ‚Äî Dashboard</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
</head>
<body>
  <header class="site-header">
    <div class="container header-bar">
      <div class="brand">
        <a class="brand-link" href="{{ url_for('index') }}">MBU Trading Bot</a>
      </div>
      <nav class="nav">
        <a class="btn ghost" href="{{ url_for('logout') }}">Log out</a>
      </nav>
    </div>
  </header>

  <main class="container">
    <!-- Top summary -->
    <section class="grid gap-lg">
      <div class="card">
        <div class="card-header">
          <h2>Account</h2>
        </div>
        <div class="card-body">
          <p><strong>Logged in as:</strong> {{ current_user.email }}</p>
          <p>
            <strong>Subscription:</strong>
            {% if current_user.subscription_active %}
              <span class="badge success">Active</span>
            {% else %}
              <span class="badge warn">Inactive</span>
            {% endif %}
          </p>

          <div class="row btn-row">
            <form method="post" action="{{ url_for('toggle_trading') }}">
              {% if current_user.trading_enabled %}
                <input type="hidden" name="action" value="stop">
                <button class="btn danger" type="submit">‚è∏Ô∏è Stop Trading</button>
              {% else %}
                <input type="hidden" name="action" value="start">
                <button class="btn primary" type="submit">‚ñ∂Ô∏è Start Trading</button>
              {% endif %}
            </form>

            <form method="post" action="{{ url_for('place_now') }}">
              <button class="btn ghost" type="submit">üß™ Place Trade Now (test)</button>
            </form>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <h2>Performance</h2>
        </div>
        <div class="card-body">
          <p><strong>Realized PnL:</strong> {{ '%.2f'|format(current_user.realized_pnl or 0) }}</p>
          {% if last_order %}
            <div class="muted">
              <strong>Last order:</strong>
              {{ last_order.ts }} ‚Ä¢ {{ last_order.broker }} ‚Ä¢
              {{ last_order.side|upper }} {{ last_order.qty }} {{ last_order.symbol }}
              @ {{ last_order.price }}
            </div>
          {% else %}
            <p class="muted">No trades yet.</p>
          {% endif %}
        </div>
      </div>
    </section>

    <!-- Schedule -->
    <section class="card">
      <div class="card-header">
        <h2>Schedule</h2>
        <p class="muted small">Default is 1 trade/day. Increase only if you understand the risks.</p>
      </div>
      <div class="card-body">
        <form method="post" action="{{ url_for('save_schedule') }}" class="form-grid">
          <label>
            <span>Timezone</span>
            <select name="timezone" required>
              {% for tz in timezones %}
                <option value="{{ tz }}" {% if tz==current_user.timezone %}selected{% endif %}>{{ tz }}</option>
              {% endfor %}
            </select>
          </label>

          <label>
            <span>Daily time (HH:MM, 24h, local)</span>
            <input type="text" name="daily_time" value="{{ current_user.daily_time or '09:30' }}" placeholder="09:30" required>
          </label>

          <label>
            <span>Trades per day (1‚Äì24)</span>
            <input type="number" name="trades_per_day" min="1" max="24" value="{{ current_user.trades_per_day or 1 }}" required>
          </label>

          <div class="actions">
            <button class="btn primary" type="submit">üíæ Save Schedule</button>
          </div>
        </form>
      </div>
    </section>

    <!-- Broker & Symbols -->
    <section class="card">
      <div class="card-header">
        <h2>Broker &amp; Symbols</h2>
      </div>
      <div class="card-body">
        <form method="post" action="{{ url_for('save_broker') }}" class="form-grid">
          <label>
            <span>Broker</span>
            <select name="broker">
              <option value="tradier" {% if current_user.broker=='tradier' %}selected{% endif %}>Tradier (US stocks)</option>
              <option value="alpaca" {% if current_user.broker=='alpaca' %}selected{% endif %}>Alpaca (stocks)</option>
              <option value="binance" {% if current_user.broker=='binance' %}selected{% endif %}>Binance (crypto)</option>
              <option value="coinbase" {% if current_user.broker=='coinbase' %}selected{% endif %}>Coinbase (crypto)</option>
            </select>
          </label>

          <label>
            <span>Symbol (e.g. AAPL or BTC/USDT)</span>
            <input name="symbol" value="{{ current_user.symbol or 'AAPL' }}" placeholder="AAPL" required />
          </label>

          <label>
            <span>Quantity</span>
            <input name="qty" type="number" step="any" value="{{ current_user.qty or 1 }}" required />
          </label>

          <label>
            <span>Side</span>
            <select name="side">
              <option value="buy"  {% if current_user.side=='buy' %}selected{% endif %}>Buy</option>
              <option value="sell" {% if current_user.side=='sell' %}selected{% endif %}>Sell</option>
            </select>
          </label>

          <!-- API Keys -->
          <div class="divider">API Keys</div>

          <label><span>ALPACA_KEY</span><input name="ALPACA_KEY" placeholder="..." /></label>
          <label><span>ALPACA_SECRET</span><input name="ALPACA_SECRET" placeholder="..." /></label>
          <label><span>ALPACA_BASE_URL</span><input name="ALPACA_BASE_URL" value="https://paper-api.alpaca.markets" /></label>

          <label><span>BINANCE_KEY</span><input name="BINANCE_KEY" placeholder="..." /></label>
          <label><span>BINANCE_SECRET</span><input name="BINANCE_SECRET" placeholder="..." /></label>

          <label><span>COINBASE_KEY</span><input name="COINBASE_KEY" placeholder="..." /></label>
          <label><span>COINBASE_SECRET</span><input name="COINBASE_SECRET" placeholder="..." /></label>
          <label><span>COINBASE_PASSPHRASE</span><input name="COINBASE_PASSPHRASE" placeholder="..." /></label>

          <div class="divider">Tradier (Stocks)</div>
          <label><span>TRADIER_TOKEN</span><input name="TRADIER_TOKEN" placeholder="..." /></label>
          <label><span>TRADIER_ACCOUNT_ID</span><input name="TRADIER_ACCOUNT_ID" placeholder="..." /></label>

          <div class="actions">
            <button class="btn primary" type="submit">üíæ Save Broker Settings</button>
          </div>
          <p class="muted small">Your keys are encrypted in the database using your server‚Äôs encryption key.</p>
        </form>
      </div>
    </section>

    <!-- Trade Logs -->
    <section class="card">
      <div class="card-header">
        <h2>Trade Logs (latest 50)</h2>
      </div>
      <div class="card-body">
        <div class="table-wrap">
          <table class="table">
            <thead>
              <tr>
                <th>Time (UTC)</th><th>Broker</th><th>Side</th><th>Qty</th><th>Symbol</th><th>Price</th><th>Realized PnL</th>
              </tr>
            </thead>
            <tbody>
              {% if logs %}
                {% for r in logs %}
                  <tr>
                    <td>{{ r.ts }}</td>
                    <td>{{ r.broker }}</td>
                    <td>{{ r.side|upper }}</td>
                    <td>{{ r.qty }}</td>
                    <td>{{ r.symbol }}</td>
                    <td>{{ r.price }}</td>
                    <td>{{ '%.2f'|format(r.realized_pnl or 0) }}</td>
                  </tr>
                {% endfor %}
              {% else %}
                <tr><td colspan="7" class="muted">No trades yet.</td></tr>
              {% endif %}
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <section class="muted small">
      <p>Help: Your site is at <code>/</code> and this dashboard is <code>/dashboard</code>. Use Start/Stop to pause trading without canceling your subscription. Wake endpoint: <code>/wake</code></p>
    </section>
  </main>

  <footer>
  <p>&copy; {{ year }} MBU Trading Bot ‚Äî All Rights Reserved</p>
</footer>
